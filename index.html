<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QUARK Bridge — Minimal Connect Fix</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#0a0f1b; --card:#121a2b; --text:#e6ebff; --muted:#9aa4c7; --accent:#6fd0ff; --danger:#ff6b6b; --border:#1c2742; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text);margin:0;display:flex;justify-content:center;align-items:center;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;width:100%;max-width:520px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    h1{margin:0 0 10px;text-align:center}
    .small{font-size:12px;color:var(--muted)}
    input,button{width:100%;padding:10px;margin-top:8px;border-radius:12px;border:1px solid var(--border);background:#0f1627;color:var(--text);font-size:14px}
    input::placeholder{color:#8aa0c7}
    button{cursor:pointer;border:none;background:linear-gradient(90deg,#31a3ff,#7be3ff);color:#001018;font-weight:700}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .hint{background:#0e1a2d;border:1px dashed var(--border);padding:10px;border-radius:12px;margin-top:8px}
    a{color:var(--accent);text-decoration:none}
  </style>
  <script src="https://unpkg.com/@cosmjs/stargate@0.31.2/build/index.min.js"></script>
</head>
<body>
  <div class="card">
    <h1>QUARK Bridge</h1>

    <div id="iframeWarn" class="hint" style="display:none">
      This page is inside a preview/iframe. <a id="openTop" href="#">Open in a new tab</a> so Keplr can connect.
    </div>

    <div id="noKeplr" class="hint" style="display:none">
      Keplr not detected. Install it and allow access on this site (HTTPS). In Chrome: Extensions → Keplr → Site access → “On all sites”.
    </div>

    <div class="row">
      <button id="connectBtn" type="button">Connect Keplr</button>
    </div>

    <div id="status" class="small" style="margin-top:10px;text-align:center"></div>
    <div id="log" class="small" style="margin-top:10px;white-space:pre-wrap;background:#0d1527;border:1px solid var(--border);border-radius:8px;padding:8px;display:none"></div>
  </div>

  <script>
    // --- Minimal constants just for connect test ---
    const RPC = "https://rpc.cosmoshub.strange.love";
    const CHAINS = ["cosmoshub-4","osmosis-1"];

    const { SigningStargateClient, GasPrice } = window.cosmjs || {};
    const $ = id => document.getElementById(id);
    const statusEl = $("status");
    const logEl = $("log");

    function log(msg){
      console.log(msg);
      logEl.style.display = "block";
      logEl.textContent += (logEl.textContent ? "\n" : "") + msg;
    }

    // If inside iframe (e.g. GitHub preview), show open-in-new-tab
    if (window.top !== window) {
      $("iframeWarn").style.display = "block";
      $("openTop").onclick = (e)=>{ e.preventDefault(); window.top.location.href = window.location.href; };
    }

    // Always keep the button clickable; never disable it.
    $("connectBtn").addEventListener("click", async () => {
      try {
        log("connectBtn clicked");
        if (!window.keplr) {
          $("noKeplr").style.display = "block";
          statusEl.textContent = "Keplr not found on this page.";
          return;
        }

        // Enable chains sequentially (more compatible)
        for (const id of CHAINS) {
          try {
            await window.keplr.enable(id);
            log(`enabled: ${id}`);
          } catch (e) {
            log(`enable failed for ${id}: ${e?.message || e}`);
            statusEl.textContent = `Permission denied for ${id}. Check Keplr site access.`;
            return;
          }
        }

        // Prefer modern API; fallback to legacy helper
        const signer =
          (window.keplr.getOfflineSignerAuto && await window.keplr.getOfflineSignerAuto("cosmoshub-4")) ||
          (window.getOfflineSigner && window.getOfflineSigner("cosmoshub-4"));

        if (!signer) {
          statusEl.textContent = "Could not obtain signer. Check Keplr permissions.";
          log("no signer returned (getOfflineSignerAuto/getOfflineSigner)");
          return;
        }

        const accts = await signer.getAccounts();
        const addr  = accts[0]?.address || "";
        log(`cosmos address: ${addr || "(none)"}`);

        // Quick client connect just to prove injection works
        const gp = GasPrice.fromString("0.025uatom");
        const client = await SigningStargateClient.connectWithSigner(RPC, signer, { gasPrice: gp });
        const chainId = await client.getChainId();
        log(`connected to RPC. chainId=${chainId}`);

        statusEl.textContent = `✅ Keplr connected. Cosmos address: ${addr}`;
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error: " + (err?.message || err);
        log("error: " + (err?.message || err));
      }
    });

    // Passive detector: if Keplr never appears, show a hint after 5s
    (async ()=>{
      const start = Date.now();
      let found = false;
      while (Date.now() - start < 5000) {
        if (window.keplr) { found = true; break; }
        await new Promise(r => setTimeout(r, 200));
      }
      if (!found) $("noKeplr").style.display = "block";
    })();
  </script>
</body>
</html>
