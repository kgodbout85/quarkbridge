<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quark IBC Bridge → Osmosis (channel-141)</title>

  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://rpc.cosmos.directory" crossorigin>

  <style>
    :root{
      --bg-1:#070a16; --bg-2:#0b1140; --card:#0f1633cc; --border:#1f2a66;
      --text:#e9edff; --muted:#aab3da; --accent-start:#7cfbff; --accent-end:#6d8bff;
      --ok:#34d399; --err:#ffb4c2;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1000px 500px at 20% -10%, #14205a55, transparent 60%),
                  radial-gradient(900px 500px at 100% 0%, #0f1b5655, transparent 60%),
                  linear-gradient(135deg, var(--bg-1), var(--bg-2));
      color:var(--text); display:flex; align-items:center; justify-content:center; padding:20px;
    }
    .app{width:100%; max-width:980px}
    .hero{display:flex; gap:16px; align-items:center; justify-content:center; margin-bottom:16px}
    .logo-wrap{width:68px;height:68px;display:grid;place-items:center;background:linear-gradient(180deg,#8df7ff22,#7099ff22);border-radius:16px;border:1px solid var(--border);box-shadow:0 10px 40px #6d8bff33}
    .logo-wrap img{width:46px;height:46px;filter:drop-shadow(0 0 12px #6d8bff66)}
    h1{margin:0;font-size:22px;letter-spacing:.2px}
    .sub{margin:2px 0 0;color:var(--muted);font-size:13px}
    .card{background:var(--card);border:1px solid var(--border);backdrop-filter:blur(10px);border-radius:16px;padding:18px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .stack{display:grid;gap:10px}
    label{font-size:13px;color:#cfd7ff;margin-bottom:6px;display:block}
    input,select,button{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0c1330;color:var(--text);font-size:15px;outline:none;transition:box-shadow .2s,transform .02s}
    input:focus,select:focus{box-shadow:0 0 0 2px #6d8bff66}
    button{background:linear-gradient(135deg,var(--accent-start),var(--accent-end));color:#0b0f26;font-weight:600;border:none}
    button:hover{filter:brightness(1.05)} button:active{transform:scale(0.98)} button.ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .status{color:var(--muted);min-height:20px} .status.ok{color:var(--ok)} .status.err{color:var(--err)}
    .addr{font-size:13px;color:#cdd6ff;background:#0c1330;border:1px dashed var(--border);padding:10px 12px;border-radius:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .divider{height:1px;background:linear-gradient(90deg,transparent,#263376 30%,#263376 70%,transparent);margin:10px 0}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#101a48;border:1px solid #263376;color:#bcd0ff;font-size:12px}
    .badge{background:#223066;border:1px solid #2d3a7a;padding:2px 8px;border-radius:999px;font-size:11px;margin-left:6px;color:#bcd0ff}
    .spinner{width:16px;height:16px;border-radius:50%;border:2px solid #ffffff55;border-top-color:#fff;animation:spin .8s linear infinite;display:inline-block;vertical-align:middle;margin-right:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .warning{display:flex;gap:10px;align-items:flex-start;background:#2a1600;border:1px solid #7c4a00;color:#ffd59e;padding:10px 12px;border-radius:12px;margin-bottom:10px}
    .warning b{color:#ffce6a}
  </style>

  <!-- CosmJS UMD (primary + fallback). If blocked, we ESM-import in boot(). -->
  <script>
    (function loadCosmjsUMD(){
      function add(src){const s=document.createElement("script");s.src=src;s.async=true;document.head.appendChild(s);}
      add("https://unpkg.com/@cosmjs/stargate@0.31.2/build/index.min.js");
      setTimeout(()=>{ if(!window.cosmjs) add("https://cdn.jsdelivr.net/npm/@cosmjs/stargate@0.31.2/build/index.min.js"); }, 600);
    })();
  </script>
</head>
<body>
  <div class="app">
    <div class="hero">
      <div class="logo-wrap"><img alt="Quark logo" src="./logo.png" onerror="this.parentElement.style.display='none'"/></div>
      <div>
        <h1>Quark IBC Bridge</h1>
        <div class="sub">Cosmos Hub → Osmosis via <span class="pill mono">channel-141</span></div>
      </div>
    </div>

    <div class="card stack">
      <div class="warning" role="alert" aria-live="polite">
        <div style="font-size:18px;line-height:1">⚠️</div>
        <div><b>Use at your own risk.</b> Not responsible for any lost funds. Always test with a small amount first.</div>
      </div>

      <div class="row">
        <div class="stack" style="min-width:200px;max-width:260px">
          <label for="walletSelect">Wallet</label>
          <select id="walletSelect">
            <option value="">Select a wallet…</option>
            <option value="keplr">Keplr</option>
            <option value="leap">Leap</option>
          </select>
        </div>
        <button id="connectBtn" type="button" disabled>Connect</button>
        <span id="status" class="status"></span>
        <button id="refreshBtn" class="ghost right" type="button" style="display:none">↻ Refresh balances</button>
      </div>

      <div id="addrWrap" class="addr" style="display:none">
        <div>Wallet: <span id="walletName" class="mono">—</span></div>
        <div>Cosmos Hub: <span id="cosmosAddr" class="mono"></span></div>
        <div>Osmosis: <span id="osmoAddr" class="mono"></span></div>
        <div>RPC: <span id="rpcUsed" class="mono"></span></div>
      </div>

      <div class="divider"></div>

      <div id="formWrap" style="display:none">
        <div class="grid">
          <div class="stack">
            <label for="denomSelect">Select asset (IBC)</label>
            <select id="denomSelect"></select>
          </div>
          <div class="stack">
            <label for="amount">Amount</label>
            <input id="amount" type="number" placeholder="e.g., 1.5" step="0.000001" min="0" />
          </div>
        </div>

        <div class="row" style="margin-top:6px">
          <div class="pill">Available: <span id="balHuman" class="mono">0.000000</span><span id="quarkBadge" class="badge" style="display:none">QUARK</span></div>
          <div class="right row" style="gap:8px">
            <button id="btn50" type="button" class="ghost">50%</button>
            <button id="btn75" type="button" class="ghost">75%</button>
            <button id="btnMax" type="button" class="ghost">Max</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="sendBtn" type="button">Send to Osmosis</button>
          <input id="memo" class="right" style="max-width:320px" placeholder="Memo (optional)" />
        </div>
      </div>

      <div id="txWrap" style="display:none; margin-top:6px">
        <span>Tx: <a id="txLink" target="_blank" rel="noopener" class="pill mono">View on Mintscan</a></span>
      </div>

      <details class="diag"><summary>Diagnostics</summary><div id="diag" class="status"></div></details>
    </div>

    <div class="footer">Tip: serve over <b>https://</b> and allow your wallet on this site.</div>
  </div>

  <script>
    // ===== Config & constants =====
    const CHANNEL = "channel-141";     // Cosmos → Osmosis
    const DEFAULT_DECIMALS = 6;
    const GAS_PRICE = 0.035;           // uatom per gas
    const GAS_BUFFER = 1.6;
    const ACTION_GRACE_MS = 1500;      // ⏳ delay before enabling Send/% buttons
    const CONNECT_TIMEOUT_MS = 15000;
    const RPC_CANDIDATES = [
      "https://rpc.cosmos.directory/cosmoshub",
      "https://rpc-cosmoshub.blockapsis.com",
      "https://cosmoshub-validator.enigma-validator.com",
      "https://rpc.cosmoshub.strange.love",
      "https://rpc-cosmoshub-ia.cosmosia.notional.ventures",
    ];
    const QUARK_IBC = "ibc/7B6EBFC446E50DFF981C994E207BFB398889706C2B0DF8A14D8B87F6C0E33A1A";

    // ===== State =====
    let WALLET_ID = "";   // "keplr" | "leap"
    let WALLET = null;    // window.keplr or window.leap
    let cosmosAddr = "", osmoAddr = "";
    let signer = null, queryClient = null, signingClient = null, connectedRpc = "";
    let balances = [];
    let connectInFlight = false, connected = false, inFlight = false;

    // ===== UI =====
    const walletSelect = document.getElementById("walletSelect");
    const connectBtn  = document.getElementById("connectBtn");
    const statusEl    = document.getElementById("status");
    const addrWrap    = document.getElementById("addrWrap");
    const walletNameEl= document.getElementById("walletName");
    const cosmosAddrEl= document.getElementById("cosmosAddr");
    const osmoAddrEl  = document.getElementById("osmoAddr");
    const rpcUsedEl   = document.getElementById("rpcUsed");
    const formWrap    = document.getElementById("formWrap");
    const denomSelect = document.getElementById("denomSelect");
    const amountInput = document.getElementById("amount");
    const balHumanEl  = document.getElementById("balHuman");
    const quarkBadge  = document.getElementById("quarkBadge");
    const memoInput   = document.getElementById("memo");
    const btn50       = document.getElementById("btn50");
    const btn75       = document.getElementById("btn75");
    const btnMax      = document.getElementById("btnMax");
    const sendBtn     = document.getElementById("sendBtn");
    const txWrap      = document.getElementById("txWrap");
    const txLink      = document.getElementById("txLink");
    const diagEl      = document.getElementById("diag");
    const refreshBtn  = document.getElementById("refreshBtn");

    // ===== Utils =====
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    const setStatus = (m,cls="")=>{ statusEl.className="status "+cls; statusEl.textContent=m||""; };
    const addDiag = (m)=>{ const d=document.createElement("div"); d.textContent=m; diagEl.appendChild(d); };
    const withTimeout=(p,ms,label="op")=>Promise.race([p,new Promise((_,rej)=>setTimeout(()=>rej(new Error(label+" timed out")),ms))]);
    const toHuman = (min,dec=DEFAULT_DECIMALS)=> (Number(min||0)/Math.pow(10,dec)).toFixed(6);
    const toMinimal = (h,dec=DEFAULT_DECIMA_
