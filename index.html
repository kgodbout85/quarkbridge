<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QUARK Bridge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9fafb;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .card {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 400px;
      width: 100%;
    }
    h1 { text-align: center; margin-bottom: 1rem; }
    input, button {
      width: 100%;
      padding: 0.75rem;
      margin: 0.5rem 0;
      border-radius: 0.5rem;
      border: 1px solid #ddd;
      font-size: 1rem;
    }
    button {
      background: #4f46e5;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover { background: #4338ca; }
    p.status { text-align: center; margin-top: 1rem; }
    p.balance { text-align: center; margin-top: 0.5rem; color: #111827; font-weight: bold; }
  </style>
  <!-- CosmJS UMD bundle -->
  <script src="https://unpkg.com/@cosmjs/stargate@0.31.2/build/index.min.js"></script>
</head>
<body>
  <div class="card">
    <h1>QUARK Bridge</h1>
    <p style="text-align:center">
      Send QUARK from <b>Cosmos Hub</b> → <b>Osmosis</b> using Keplr
    </p>

    <button id="connectBtn">Connect Keplr</button>
    <p id="balance" class="balance" style="display:none"></p>

    <input id="amount" type="number" placeholder="Amount of QUARK" disabled />
    <button id="bridgeBtn" disabled>Bridge</button>

    <p id="status" class="status"></p>
    <p id="warning" style="color:red; text-align:center;"></p>
  </div>

  <script>
    // --- Config ---
    const denom   = "factory/cosmos1n6asrjy9754q8y9jsxqf557zmsv3s3xa5m9eg5/quark";
    const channel = "channel-141"; // Cosmos → Osmosis
    const RPC     = "https://rpc.cosmoshub.strange.love"; // same RPC you used

    let fromAddress = "";
    let toAddress   = "";
    let cosmosSigner;

    const connectBtn  = document.getElementById("connectBtn");
    const bridgeBtn   = document.getElementById("bridgeBtn");
    const amountInput = document.getElementById("amount");
    const statusEl    = document.getElementById("status");
    const warningEl   = document.getElementById("warning");
    const balanceEl   = document.getElementById("balance");

    // Show a warning if Keplr isn't injected
    if (!window.keplr) {
      warningEl.textContent = "⚠️ Keplr not detected. Open this page on HTTPS with Keplr installed/enabled.";
    }

    // Fetch & display QUARK balance (no GasPrice used)
    async function fetchQuarkBalance() {
      try {
        if (!fromAddress) return;
        const { StargateClient } = window.cosmjs || {};
        if (!StargateClient) throw new Error("CosmJS not loaded");
        const q = await StargateClient.connect(RPC);
        const bal = await q.getBalance(fromAddress, denom);
        const amtMinimal = BigInt(bal?.amount ?? "0");
        const amtWhole = Number(amtMinimal) / 1_000_000; // 6 decimals
        balanceEl.style.display = "block";
        balanceEl.textContent = `Available: ${amtWhole.toFixed(6)} QUARK`;
      } catch (e) {
        console.error("Balance fetch error:", e);
        balanceEl.style.display = "block";
        balanceEl.textContent = "Available: 0.000000 QUARK";
      }
    }

    connectBtn.onclick = async () => {
      try {
        if (!window.keplr) {
          alert("Keplr not found. Make sure it's installed and allowed on this site.");
          return;
        }

        // Enable both chains
        await window.keplr.enable(["cosmoshub-4", "osmosis-1"]);

        // Use the same signer API you had working
        cosmosSigner = window.getOfflineSigner("cosmoshub-4");
        const cosmosAccounts = await cosmosSigner.getAccounts();
        fromAddress = cosmosAccounts[0].address;

        const osmoSigner = window.getOfflineSigner("osmosis-1");
        const osmoAccounts = await osmoSigner.getAccounts();
        toAddress = osmoAccounts[0].address;

        connectBtn.disabled  = true;
        amountInput.disabled = false;
        bridgeBtn.disabled   = false;
        statusEl.textContent = "✅ Keplr connected!";
        warningEl.textContent = "";

        // NEW: fetch balance after connecting
        await fetchQuarkBalance();
      } catch (err) {
        console.error(err);
        statusEl.textContent = "❌ Error connecting: " + err.message;
      }
    };

    bridgeBtn.onclick = async () => {
      try {
        const amount = parseFloat(amountInput.value);
        if (!amount || amount <= 0) {
          alert("Enter a valid amount of QUARK.");
          return;
        }

        const { SigningStargateClient } = window.cosmjs || {};
        const client = await SigningStargateClient.connectWithSigner(RPC, cosmosSigner);

        const msg = {
          typeUrl: "/ibc.applications.transfer.v1.MsgTransfer",
          value: {
            sourcePort: "transfer",
            sourceChannel: channel,
            sender: fromAddress,
            receiver: toAddress,
            token: {
              denom: denom,
              amount: String(Math.round(amount * 1_000_000)), // avoid float dust
            },
            timeoutHeight: {},
            timeoutTimestamp: String((Date.now() + 600_000) * 1e6), // +10 min in ns
          },
        };

        const fee = {
          amount: [{ denom: "uatom", amount: "5000" }],
          gas: "200000",
        };

        const result = await client.signAndBroadcast(fromAddress, [msg], fee);

        if (result.code === 0) {
          statusEl.textContent = "✅ Success! QUARK bridged to Osmosis.";
          // Refresh balance after sending
          await fetchQuarkBalance();
        } else {
          statusEl.textContent = "❌ Failed: " + result.rawLog;
        }
      } catch (err) {
        console.error(err);
        statusEl.textContent = "❌ Error: " + err.message;
      }
    };
  </script>
</body>
</html>
