<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IBC Transfer → Osmosis (channel-141)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0f1222; color:#e9edff; display:flex; min-height:100vh; align-items:center; justify-content:center; padding:24px }
    .card { width:100%; max-width:680px; background:#151a33; border:1px solid #222a55; border-radius:16px; padding:20px; box-shadow:0 16px 40px rgba(0,0,0,.35) }
    h1 { margin:0 0 6px; font-size:20px }
    .sub { color:#aab3da; font-size:13px; margin:0 0 12px }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    label { font-size:14px; color:#cfd7ff }
    input, select, button { width:100%; padding:12px; border-radius:10px; border:1px solid #2a3266; background:#0f1533; color:#e9edff; font-size:15px }
    button { background:#6d8bff; border:none; cursor:pointer }
    button:disabled { opacity:.6; cursor:not-allowed }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace }
    .addr { background:#0f1533; border:1px solid #222a55; border-radius:12px; padding:10px 12px; font-size:13px; color:#bfc7ee }
    .status { color:#aab3da; min-height:20px; margin:8px 0 }
    .error { color:#ffb4c2 }
    .rpc { font-size:12px; color:#bfc7ee }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px }
    small { color:#aab3da }
    a.link { color:#9fb2ff; text-decoration: underline }
  </style>

  <!-- CosmJS UMD (primary + fallback). If blocked, we ESM-import in boot(). -->
  <script>
    (function loadCosmjsUMD() {
      function add(src){ const s=document.createElement("script"); s.src=src; s.async=true; document.head.appendChild(s); }
      add("https://unpkg.com/@cosmjs/stargate@0.31.2/build/index.min.js");
      setTimeout(()=>{ if(!window.cosmjs) add("https://cdn.jsdelivr.net/npm/@cosmjs/stargate@0.31.2/build/index.min.js"); }, 600);
    })();
  </script>
</head>
<body>
  <div class="card">
    <h1>IBC Transfer → Osmosis</h1>
    <p class="sub">Cosmos Hub (cosmoshub-4) → Osmosis via <b>channel-141</b></p>

    <div class="row" style="margin-bottom:8px">
      <button id="connectBtn" type="button" disabled>Initializing…</button>
      <span id="status" class="status"></span>
    </div>

    <div id="addrWrap" class="addr" style="display:none; margin-bottom:12px">
      <div>Cosmos: <span id="cosmosAddr" class="mono"></span></div>
      <div>Osmosis: <span id="osmoAddr" class="mono"></span></div>
      <div class="rpc">RPC: <span id="rpcUsed" class="mono">—</span></div>
    </div>

    <div id="formWrap" style="display:none">
      <div class="grid">
        <div>
          <label for="denomSelect">IBC asset (Cosmos Hub)</label>
          <select id="denomSelect"></select>
        </div>
        <div>
          <label for="amount">Amount (human, ~6dp)</label>
          <input id="amount" type="number" placeholder="e.g., 1.5" step="0.000001" min="0" />
        </div>
      </div>

      <div class="grid" style="margin-top:6px">
        <div>
          <small>Available (minimal): <span id="balMinimal" class="mono">0</span></small><br/>
          <small>Available (~human): <span id="balHuman" class="mono">0.000000</span></small>
        </div>
        <div class="row">
          <button id="btn50" type="button">50%</button>
          <button id="btn75" type="button">75%</button>
          <button id="btnMax" type="button">Max</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="sendBtn" type="button">Send via channel-141</button>
      </div>

      <div class="row" style="margin-top:6px">
        <input id="memo" placeholder="Memo (optional)" />
      </div>
    </div>

    <div id="txWrap" style="display:none; margin-top:10px">
      <span>Tx: <a id="txLink" target="_blank" rel="noopener" class="link">View in explorer</a></span>
    </div>

    <div id="diag" class="rpc" style="margin-top:10px"></div>
  </div>

  <script>
    // ---------- Config ----------
    const CHANNEL = "channel-141"; // Cosmos → Osmosis
    const DEFAULT_DECIMALS = 6;
    const GAS_PRICE = 0.035;       // uatom per gas
    const GAS_BUFFER = 1.6;        // 60% over simulate

    const RPC_CANDIDATES = [
      "https://rpc.cosmos.directory/cosmoshub",
      "https://rpc-cosmoshub.blockapsis.com",
      "https://cosmoshub-validator.enigma-validator.com",
      "https://rpc.cosmoshub.strange.love",
      "https://rpc-cosmoshub-ia.cosmosia.notional.ventures"
    ];

    // ---------- State ----------
    let cosmosAddr = "";
    let osmoAddr   = "";
    let connectedRpc = "";
    let queryClient = null;           // StargateClient (queries)
    let signingClient = null;         // SigningStargateClient (tx)
    let signer = null;
    let balances = [];                // ibc/* non-zero balances
    let connectInFlight = false;
    let connected = false;
    let inFlight = false;

    // ---------- UI ----------
    const connectBtn  = document.getElementById("connectBtn");
    const statusEl    = document.getElementById("status");
    const addrWrap    = document.getElementById("addrWrap");
    const cosmosAddrEl= document.getElementById("cosmosAddr");
    const osmoAddrEl  = document.getElementById("osmoAddr");
    const rpcUsedEl   = document.getElementById("rpcUsed");
    const formWrap    = document.getElementById("formWrap");
    const denomSelect = document.getElementById("denomSelect");
    const amountInput = document.getElementById("amount");
    const balMinimalEl= document.getElementById("balMinimal");
    const balHumanEl  = document.getElementById("balHuman");
    const memoInput   = document.getElementById("memo");
    const btn50 = document.getElementById("btn50");
    const btn75 = document.getElementById("btn75");
    const btnMax = document.getElementById("btnMax");
    const sendBtn = document.getElementById("sendBtn");
    const txWrap = document.getElementById("txWrap");
    const txLink = document.getElementById("txLink");
    const diagEl = document.getElementById("diag");

    // ---------- Boot: wait for Keplr & CosmJS BEFORE enabling the button ----------
    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
    function addDiag(msg){ const d=document.createElement("div"); d.textContent=msg; diagEl.appendChild(d); }

    async function ensureCosmjsReady() {
      const start = Date.now();
      while (!window.cosmjs && Date.now() - start < 2500) {
        await sleep(100);
      }
      if (window.cosmjs) return;
      try {
        const mod = await import("https://esm.sh/@cosmjs/stargate@0.31.2?bundle");
        window.cosmjs = { StargateClient: mod.StargateClient, SigningStargateClient: mod.SigningStargateClient };
      } catch (e) {
        addDiag("ESM import failed (CSP?): " + (e?.message || e));
        throw new Error("CosmJS failed to load.");
      }
    }

    async function waitForKeplr(timeoutMs=10000) {
      const start = Date.now();
      while (!window.keplr && Date.now() - start < timeoutMs) {
        await sleep(100);
      }
      if (!window.keplr) throw new Error("Keplr not detected. Use HTTPS and enable the extension.");
    }

    async function boot() {
      try {
        statusEl.textContent = "Preparing wallet…";
        await Promise.all([ensureCosmjsReady(), waitForKeplr()]);
        statusEl.textContent = "Ready to connect.";
        connectBtn.textContent = "Connect Keplr";
        connectBtn.disabled = false;

        // Update UI automatically if user switches accounts in Keplr
        window.addEventListener("keplr_keystorechange", async () => {
          if (!connected) return;
          try {
            await window.keplr.enable(["cosmoshub-4", "osmosis-1"]);
            const cosSigner = window.getOfflineSigner("cosmoshub-4");
            const cosAcc = await cosSigner.getAccounts();
            cosmosAddr = cosAcc[0]?.address || cosmosAddr;
            cosmosAddrEl.textContent = cosmosAddr;

            const osmoSigner = window.getOfflineSigner("osmosis-1");
            const osmoAcc = await osmoSigner.getAccounts();
            osmoAddr = osmoAcc[0]?.address || osmoAddr;
            osmoAddrEl.textContent = osmoAddr;

            // refresh balances
            balances = await getIbcBalances(cosmosAddr);
            populateDropdown();
            statusEl.textContent = "Account changed. Updated balances.";
          } catch (e) {
            addDiag("keystorechange refresh failed: " + (e?.message || e));
          }
        });
      } catch (e) {
        statusEl.innerHTML = `<span class="error">❌ ${e?.message || e}</span>`;
      }
    }
    document.addEventListener("DOMContentLoaded", boot);

    // ---------- Helpers ----------
    function toHuman(minimalStr, dec = DEFAULT_DECIMALS) {
      const n = Number(minimalStr || 0);
      return (n / Math.pow(10, dec)).toFixed(6);
    }
    function toMinimal(human, dec = DEFAULT_DECIMALS) {
      return String(Math.round(Number(human) * Math.pow(10, dec)));
    }
    function disableForm(disabled) {
      denomSelect.disabled = disabled;
      amountInput.disabled = disabled;
      btn50.disabled = btn75.disabled = btnMax.disabled = disabled;
      sendBtn.disabled = disabled;
      memoInput.disabled = disabled;
    }

    async function connectAnyRpc() {
      const { StargateClient } = window.cosmjs;
      for (const rpc of RPC_CANDIDATES) {
        try {
          const c = await StargateClient.connect(rpc);
          await c.getHeight();
          connectedRpc = rpc;
          return c;
        } catch (e) {
          addDiag(`RPC failed: ${rpc} — ${e?.message || e}`);
        }
      }
      throw new Error("All Cosmos Hub RPCs failed (CORS/offline).");
    }

    async function getIbcBalances(addr) {
      const coins = await queryClient.getAllBalances(addr);
      return (coins || []).filter(c => c.denom?.startsWith("ibc/") && BigInt(c.amount || "0") > 0n);
    }

    function populateDropdown() {
      denomSelect.innerHTML = "";
      balances.sort((a,b)=>a.denom.localeCompare(b.denom));
      for (const c of balances) {
        const opt = document.createElement("option");
        opt.value = c.denom;
        opt.textContent = `${c.denom} — ${toHuman(c.amount)} (~${c.amount} minimal)`;
        denomSelect.appendChild(opt);
      }
      if (balances.length > 0) {
        denomSelect.value = balances[0].denom;
        updateSelected();
      }
    }

    function findSelectedCoin() {
      const denom = denomSelect.value;
      return balances.find(c => c.denom === denom) || { amount:"0", denom };
    }

    function updateSelected() {
      const coin = findSelectedCoin();
      balMinimalEl.textContent = coin.amount;
      balHumanEl.textContent = toHuman(coin.amount);
    }

    async function warmUpSigning() {
      const { SigningStargateClient } = window.cosmjs;
      signingClient = await SigningStargateClient.connectWithSigner(connectedRpc, signer, {
        broadcastTimeoutMs: 60_000,
        broadcastPollIntervalMs: 3_000,
      });
      await signingClient.getSequence(cosmosAddr);
    }

    function wantRetry(errMsg) {
      const m = (errMsg || "").toLowerCase();
      return (
        m.includes("timeout") ||
        (m.includes("insufficient") && m.includes("fee")) ||
        m.includes("out of gas") ||
        m.includes("account sequence")
      );
    }

    async function sendIbcWithRetries(coin, minimal, memo) {
      let attempt = 0;
      let lastErr;
      while (attempt < 3) {
        attempt++;
        try {
          await signingClient.getSequence(cosmosAddr);
          const msg = {
            typeUrl: "/ibc.applications.transfer.v1.MsgTransfer",
            value: {
              sourcePort: "transfer",
              sourceChannel: CHANNEL,
              sender: cosmosAddr,
              receiver: osmoAddr,
              token: { denom: coin.denom, amount: minimal },
              timeoutHeight: {},
              timeoutTimestamp: String((Date.now() + 20 * 60 * 1000) * 1e6), // +20 min
            },
          };
          statusEl.textContent = attempt === 1 ? "Simulating gas…" : `Simulating gas… (retry ${attempt})`;
          const gasEst = await signingClient.simulate(cosmosAddr, [msg], memo || "");
          const gas = Math.ceil(gasEst * GAS_BUFFER);
          const fee = {
            gas: String(gas),
            amount: [{ denom: "uatom", amount: String(Math.ceil(gas * GAS_PRICE)) }],
          };
          statusEl.textContent = attempt === 1 ? "Broadcasting…" : `Broadcasting… (retry ${attempt})`;
          const res = await signingClient.signAndBroadcast(cosmosAddr, [msg], fee, memo || "");
          if (res.code === 0) return res;
          const raw = res.rawLog || `code ${res.code}`;
          if (!wantRetry(raw)) throw new Error(raw);
          lastErr = new Error(raw);
        } catch (e) {
          const em = e?.message || String(e);
          if (!wantRetry(em)) throw e;
          lastErr = e;
          await sleep(1200 * attempt);
        }
      }
      throw lastErr || new Error("Broadcast failed.");
    }

    // ---------- Events ----------
    denomSelect.onchange = updateSelected;
    btn50.onclick = () => { const c=findSelectedCoin(); amountInput.value = toHuman((BigInt(c.amount)*50n)/100n); };
    btn75.onclick = () => { const c=findSelectedCoin(); amountInput.value = toHuman((BigInt(c.amount)*75n)/100n); };
    btnMax.onclick = () => { const c=findSelectedCoin(); amountInput.value = toHuman(BigInt(c.amount)); };

    connectBtn.onclick = async () => {
      try {
        if (connectInFlight || connected) return;
        connectInFlight = true;
        connectBtn.disabled = true;
        connectBtn.textContent = "Connecting…";
        statusEl.textContent = "Requesting Keplr permission…";

        // Make sure both are ready (extra safety if user clicked instantly after boot)
        await Promise.all([ensureCosmjsReady(), waitForKeplr()]);

        await window.keplr.enable(["cosmoshub-4", "osmosis-1"]);

        // Addresses
        signer = window.getOfflineSigner("cosmoshub-4");
        const cosAcc = await signer.getAccounts();
        cosmosAddr = cosAcc[0]?.address || "";
        const osmoSigner = window.getOfflineSigner("osmosis-1");
        const osmoAcc = await osmoSigner.getAccounts();
        osmoAddr = osmoAcc[0]?.address || "";
        if (!cosmosAddr || !osmoAddr) throw new Error("Missing Cosmos/Osmosis accounts.");

        statusEl.textContent = "Finding RPC…";
        const { StargateClient } = window.cosmjs;
        for (const rpc of RPC_CANDIDATES) {
          try {
            const c = await StargateClient.connect(rpc);
            await c.getHeight();
            connectedRpc = rpc;
            queryClient = c;
            break;
          } catch (e) {
            addDiag(`RPC failed: ${rpc} — ${e?.message || e}`);
          }
        }
        if (!queryClient) throw new Error("All Cosmos Hub RPCs failed (CORS/offline).");

        // Warm up signing client now, so first send works immediately
        statusEl.textContent = "Preparing signer…";
        await warmUpSigning();

        // UI updates
        cosmosAddrEl.textContent = cosmosAddr;
        osmoAddrEl.textContent = osmoAddr;
        rpcUsedEl.textContent = connectedRpc;
        addrWrap.style.display = "block";

        statusEl.textContent = "Loading IBC balances…";
        balances = await getIbcBalances(cosmosAddr);
        if (balances.length === 0) {
          statusEl.innerHTML = "No IBC balances found on Cosmos Hub.";
        } else {
          populateDropdown();
          formWrap.style.display = "block";
          statusEl.textContent = "Connected.";
        }

        // Lock the button to indicate success (no second press needed)
        connected = true;
        connectBtn.textContent = "Connected ✅";
      } catch (e) {
        console.error(e);
        statusEl.innerHTML = `<span class="error">❌ ${e?.message || e}</span>`;
        connectBtn.textContent = "Connect Keplr";
        connectBtn.disabled = false; // allow a re-try if something failed
      } finally {
        connectInFlight = false;
      }
    };

    sendBtn.onclick = async () => {
      try {
        if (inFlight) return;
        const human = Number((amountInput.value || "").trim());
        if (!human || human <= 0) return alert("Enter a valid amount.");

        const coin = findSelectedCoin();
        const minimal = toMinimal(human);
        if (BigInt(minimal) > BigInt(coin.amount || "0")) {
          return alert("Amount exceeds available balance.");
        }

        inFlight = true;
        disableForm(true);
        txWrap.style.display = "none";
        statusEl.textContent = "Preparing transaction…";

        // Ensure permissions still live (rare edge case)
        await window.keplr.enable(["cosmoshub-4", "osmosis-1"]);

        const res = await sendIbcWithRetries(coin, minimal, memoInput.value || "");

        statusEl.textContent = "✅ Sent!";
        const hash = res.transactionHash || "";
        if (hash) {
          txWrap.style.display = "block";
          txLink.href = `https://www.mintscan.io/cosmos/txs/${hash}`;
          txLink.textContent = hash;
        }

        // Refresh selected denom
        setTimeout(async () => {
          const fresh = await queryClient.getAllBalances(cosmosAddr);
          const updated = fresh.find(x => x.denom === coin.denom) || { amount:"0", denom: coin.denom };
          coin.amount = updated.amount;
          updateSelected();
        }, 2500);
      } catch (e) {
        console.error(e);
        statusEl.innerHTML = `<span class="error">❌ ${e?.message || e}</span>`;
      } finally {
        inFlight = false;
        disableForm(false);
      }
    };
  </script>
</body>
</html>
