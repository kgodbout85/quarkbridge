<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cosmos → Osmosis (channel-141)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; background:#f7f7fb; margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center }
    .card { background:#fff; width:100%; max-width:500px; padding:24px; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.08) }
    h1 { margin:0 0 8px; font-size:20px; text-align:center }
    .muted { color:#6b7280; font-size:13px }
    .addr { background:#f3f4f6; padding:10px; border-radius:10px; font-size:14px; margin:10px 0 }
    label { font-size:14px; color:#374151; display:block; margin-top:8px }
    input, select, button { width:100%; padding:12px; margin-top:6px; border-radius:10px; border:1px solid #e3e3ee; font-size:16px; background:#fff }
    .row { display:flex; gap:8px; margin-top:8px }
    .row button { flex:1 }
    button { background:#4f46e5; color:#fff; border:none; cursor:pointer }
    button:hover { background:#4338ca }
    button:disabled { opacity:.5; cursor:not-allowed }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace }
    .status { text-align:center; min-height:22px; margin-top:10px }
    .warn { color:#b91c1c; text-align:center }
  </style>

  <!-- CosmJS UMD -->
  <script src="https://unpkg.com/@cosmjs/stargate@0.31.2/build/index.min.js"></script>
  <script>
    // Fallback loader (some adblockers block unpkg)
    setTimeout(() => {
      if (!window.cosmjs) {
        const s = document.createElement("script");
        s.src = "https://cdn.jsdelivr.net/npm/@cosmjs/stargate@0.31.2/build/index.min.js";
        document.head.appendChild(s);
      }
    }, 700);
  </script>
</head>
<body>
  <div class="card">
    <h1>Bridge to Osmosis</h1>
    <p class="muted" style="text-align:center">Cosmos → Osmosis via <b>channel-141</b></p>

    <button id="connectBtn">Connect Keplr</button>

    <div id="addrBox" class="addr" style="display:none">
      <div>Cosmos: <span id="fromAddr" class="mono"></span></div>
      <div>Osmosis: <span id="toAddr" class="mono"></span></div>
    </div>

    <div id="balanceUI" style="display:none">
      <label for="denomSelect">Choose a Cosmos asset</label>
      <select id="denomSelect"></select>

      <div class="muted">
        Available: <span id="balWhole" class="mono">0.000000</span>
        (<span id="balMinimal" class="mono">0</span> minimal)
      </div>

      <label for="amount">Amount to send</label>
      <input id="amount" type="number" placeholder="e.g., 1.5" step="0.000001" min="0" disabled />

      <div class="row">
        <button id="btn50" disabled>50%</button>
        <button id="btn75" disabled>75%</button>
        <button id="btnMax" disabled>Max</button>
      </div>
    </div>

    <button id="bridgeBtn" disabled>Send on channel-141</button>

    <p id="status" class="status"></p>
    <p id="warning" class="warn"></p>
  </div>

  <script>
    // --- Config ---
    const RPC = "https://rpc.cosmoshub.strange.love"; // Cosmos Hub RPC
    const CHANNEL = "channel-141";                     // Cosmos → Osmosis
    const DEFAULT_DECIMALS = 6;                        // display assumption if no metadata
    const GAS_PRICE = 0.025;                           // uatom per gas (no fromString)

    // State
    let fromAddress = "";
    let toAddress = "";
    let cosmosSigner;
    let allBalances = [];            // non-zero balances from Cosmos Hub
    let selectedDenom = "";
    let selectedBalMinimal = 0n;

    // UI els
    const connectBtn  = document.getElementById("connectBtn");
    const bridgeBtn   = document.getElementById("bridgeBtn");
    const amountInput = document.getElementById("amount");
    const statusEl    = document.getElementById("status");
    const warningEl   = document.getElementById("warning");
    const addrBox     = document.getElementById("addrBox");
    const fromAddrEl  = document.getElementById("fromAddr");
    const toAddrEl    = document.getElementById("toAddr");
    const denomSelect = document.getElementById("denomSelect");
    const balanceUI   = document.getElementById("balanceUI");
    const balWholeEl  = document.getElementById("balWhole");
    const balMinEl    = document.getElementById("balMinimal");
    const btn50 = document.getElementById("btn50");
    const btn75 = document.getElementById("btn75");
    const btnMax = document.getElementById("btnMax");

    // Helpers
    if (!window.keplr) {
      warningEl.textContent = "⚠️ Keplr not detected. Open this page over HTTPS with Keplr installed/enabled.";
    }
    const toWhole = (minimal, dec = DEFAULT_DECIMALS) =>
      (Number(minimal || 0) / Math.pow(10, dec)).toFixed(6);
    const toMinimal = (whole, dec = DEFAULT_DECIMALS) =>
      String(Math.round(Number(whole) * Math.pow(10, dec)));

    async function ensureCosmjsReady() {
      const start = Date.now();
      while (!window.cosmjs && Date.now() - start < 4000) {
        await new Promise(r => setTimeout(r, 100));
      }
      if (!window.cosmjs) throw new Error("CosmJS failed to load. Refresh or disable blockers.");
    }

    async function fetchAllBalances() {
      await ensureCosmjsReady();
      const { StargateClient } = window.cosmjs;
      const q = await StargateClient.connect(RPC);
      const list = await q.getAllBalances(fromAddress) || [];
      // keep only non-zero
      return list.filter(c => {
        try { return BigInt(c.amount || "0") > 0n; } catch { return false; }
      });
    }

    function populateDenoms(list) {
      denomSelect.innerHTML = "";
      // sort IBC/factory first, then alpha
      list.sort((a,b) => {
        const pa = (a.denom.startsWith("ibc/") || a.denom.startsWith("factory/")) ? "0" : "1";
        const pb = (b.denom.startsWith("ibc/") || b.denom.startsWith("factory/")) ? "0" : "1";
        return (pa + a.denom).localeCompare(pb + b.denom);
      });

      for (const c of list) {
        const opt = document.createElement("option");
        opt.value = c.denom;
        opt.textContent = `${c.denom} — ${toWhole(c.amount)} (~${c.amount} minimal)`;
        denomSelect.appendChild(opt);
      }

      if (list.length > 0) denomSelect.value = list[0].denom;
      updateSelectedBalance();
    }

    function updateSelectedBalance() {
      selectedDenom = denomSelect.value;
      const coin = allBalances.find(c => c.denom === selectedDenom) || { amount: "0" };
      selectedBalMinimal = BigInt(coin.amount || "0");
      balMinEl.textContent = selectedBalMinimal.toString();
      balWholeEl.textContent = toWhole(selectedBalMinimal);

      const enable = selectedBalMinimal > 0n;
      amountInput.disabled = !enable;
      btn50.disabled = btn75.disabled = btnMax.disabled = !enable;
      bridgeBtn.disabled = !enable;
      if (!enable) amountInput.value = "";
    }

    btn50.onclick = () => { amountInput.value = toWhole((selectedBalMinimal * 50n) / 100n); };
    btn75.onclick = () => { amountInput.value = toWhole((selectedBalMinimal * 75n) / 100n); };
    btnMax.onclick = () => { amountInput.value = toWhole(selectedBalMinimal); };
    denomSelect.onchange = updateSelectedBalance;

    connectBtn.onclick = async () => {
      try {
        if (!window.keplr) return alert("Keplr not found. Install/enable Keplr.");

        // Enable chains
        await window.keplr.enable(["cosmoshub-4", "osmosis-1"]);

        // Get addresses
        const cosSigner = window.getOfflineSigner("cosmoshub-4");
        const cosAcc = await cosSigner.getAccounts();
        fromAddress = cosAcc[0]?.address || "";
        cosmosSigner = cosSigner;

        const osmoSigner = window.getOfflineSigner("osmosis-1");
        const osmoAcc = await osmoSigner.getAccounts();
        toAddress = osmoAcc[0]?.address || "";

        // UI
        connectBtn.disabled = true;
        fromAddrEl.textContent = fromAddress || "—";
        toAddrEl.textContent = toAddress || "—";
        addrBox.style.display = "block";

        statusEl.textContent = "Loading balances…";
        allBalances = await fetchAllBalances();
        balanceUI.style.display = "block";
        if (allBalances.length === 0) {
          statusEl.textContent = "No non-zero balances on Cosmos Hub.";
        } else {
          populateDenoms(allBalances);
          statusEl.textContent = "Balances loaded.";
        }
      } catch (e) {
        console.error(e);
        statusEl.textContent = "❌ Connect error: " + (e?.message || e);
      }
    };

    bridgeBtn.onclick = async () => {
      try {
        const amt = Number((amountInput.value || "").trim());
        if (!amt || amt <= 0) return alert("Enter a valid amount.");
        const minimal = toMinimal(amt);

        if (BigInt(minimal) > selectedBalMinimal) {
          return alert("Amount exceeds available balance.");
        }

        await ensureCosmjsReady();
        const { SigningStargateClient } = window.cosmjs || {};
        if (!SigningStargateClient) throw new Error("SigningStargateClient unavailable.");

        const client = await SigningStargateClient.connectWithSigner(RPC, cosmosSigner);

        const msg = {
          typeUrl: "/ibc.applications.transfer.v1.MsgTransfer",
          value: {
            sourcePort: "transfer",
            sourceChannel: CHANNEL,
            sender: fromAddress,
            receiver: toAddress,
            token: { denom: selectedDenom, amount: minimal },
            timeoutHeight: {}, // rely on timestamp
            timeoutTimestamp: String((Date.now() + 10 * 60 * 1000) * 1e6), // +10 min in ns
          },
        };

        // --- Fee: simulate then compute amount at GAS_PRICE uatom per gas
        const gasEst = await client.simulate(fromAddress, [msg], "");
        const gas = Math.ceil(gasEst * 1.3); // 30% buffer
        const fee = {
          gas: String(gas),
          amount: [{ denom: "uatom", amount: String(Math.ceil(gas * GAS_PRICE)) }],
        };

        statusEl.textContent = "Broadcasting…";
        const res = await client.signAndBroadcast(fromAddress, [msg], fee);

        if (res.code === 0) {
          statusEl.textContent = "✅ Sent to Osmosis. Refreshing balances…";
          setTimeout(async () => {
            allBalances = await fetchAllBalances();
            populateDenoms(allBalances);
            statusEl.textContent = "Updated balances.";
          }, 2500);
        } else {
          statusEl.textContent = "❌ Failed: " + (res.rawLog || ("code " + res.code));
        }
      } catch (e) {
        console.error(e);
        statusEl.textContent = "❌ Error: " + (e?.message || e);
      }
    };
  </script>
</body>
</html>
