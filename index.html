<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quark IBC Bridge → Osmosis (channel-141)</title>

  <!-- Performance & reliability hints -->
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://rpc.cosmos.directory" crossorigin>

  <style>
    :root{
      --bg-1:#070a16; --bg-2:#0b1140; --card:#0f1633cc; --border:#1f2a66;
      --text:#e9edff; --muted:#aab3da; --accent-start:#7cfbff; --accent-end:#6d8bff;
      --ok:#34d399; --err:#ffb4c2;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1000px 500px at 20% -10%, #14205a55, transparent 60%),
                  radial-gradient(900px 500px at 100% 0%, #0f1b5655, transparent 60%),
                  linear-gradient(135deg, var(--bg-1), var(--bg-2));
      color:var(--text); display:flex; align-items:center; justify-content:center; padding:20px;
    }
    .app{width:100%; max-width:980px}
    .hero{display:flex; gap:16px; align-items:center; justify-content:center; margin-bottom:16px}
    .logo-wrap{width:68px;height:68px;display:grid;place-items:center;background:linear-gradient(180deg,#8df7ff22,#7099ff22);border-radius:16px;border:1px solid var(--border);box-shadow:0 10px 40px #6d8bff33}
    .logo-wrap img{width:46px;height:46px;filter:drop-shadow(0 0 12px #6d8bff66)}
    h1{margin:0;font-size:22px;letter-spacing:.2px}
    .sub{margin:2px 0 0;color:var(--muted);font-size:13px}
    .card{background:var(--card);border:1px solid var(--border);backdrop-filter:blur(10px);border-radius:16px;padding:18px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .stack{display:grid;gap:10px}
    label{font-size:13px;color:#cfd7ff;margin-bottom:6px;display:block}
    input,select,button{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0c1330;color:var(--text);font-size:15px;outline:none;transition:box-shadow .2s,transform .02s}
    input:focus,select:focus{box-shadow:0 0 0 2px #6d8bff66}
    button{background:linear-gradient(135deg,var(--accent-start),var(--accent-end));color:#0b0f26;font-weight:600;border:none}
    button:hover{filter:brightness(1.05)} button:active{transform:scale(0.98)} button.ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .status{color:var(--muted);min-height:20px} .status.ok{color:var(--ok)} .status.err{color:var(--err)}
    .addr{font-size:13px;color:#cdd6ff;background:#0c1330;border:1px dashed var(--border);padding:10px 12px;border-radius:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .divider{height:1px;background:linear-gradient(90deg,transparent,#263376 30%,#263376 70%,transparent);margin:10px 0}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#101a48;border:1px solid #263376;color:#bcd0ff;font-size:12px}
    .badge{background:#223066;border:1px solid #2d3c7a;padding:2px 8px;border-radius:999px;font-size:11px;margin-left:6px;color:#bcd0ff}
    .spinner{width:16px;height:16px;border-radius:50%;border:2px solid #ffffff55;border-top-color:#fff;animation:spin .8s linear infinite;display:inline-block;vertical-align:middle;margin-right:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
    details.diag summary{cursor:pointer;color:#9fb2ff} details.diag{font-size:12px;color:#aab3da}
  </style>

  <!-- CosmJS UMD (primary + fallback). If blocked, we ESM-import in boot(). -->
  <script>
    (function loadCosmjsUMD(){
      function add(src){const s=document.createElement("script");s.src=src;s.async=true;document.head.appendChild(s);}
      add("https://unpkg.com/@cosmjs/stargate@0.31.2/build/index.min.js");
      setTimeout(()=>{ if(!window.cosmjs) add("https://cdn.jsdelivr.net/npm/@cosmjs/stargate@0.31.2/build/index.min.js"); }, 600);
    })();
  </script>
</head>
<body>
  <div class="app">
    <div class="hero">
      <div class="logo-wrap"><img alt="Quark logo" src="./logo.png" onerror="this.parentElement.style.display='none'"/></div>
      <div>
        <h1>Quark IBC Bridge</h1>
        <div class="sub">Cosmos Hub → Osmosis via <span class="pill mono">channel-141</span></div>
      </div>
    </div>

    <div class="card stack">
      <div class="row">
        <button id="connectBtn" type="button" disabled><span class="spinner" id="bootSpin"></span>Initializing…</button>
        <span id="status" class="status"></span>
        <button id="refreshBtn" class="ghost right" type="button" style="display:none">↻ Refresh balances</button>
        <button id="resetBtn" class="ghost" type="button" style="display:none">Reset</button>
      </div>

      <div id="addrWrap" class="addr" style="display:none">
        <div>Cosmos Hub: <span id="cosmosAddr" class="mono"></span></div>
        <div>Osmosis: <span id="osmoAddr" class="mono"></span></div>
        <div>RPC: <span id="rpcUsed" class="mono"></span></div>
      </div>

      <div class="divider"></div>

      <div id="formWrap" style="display:none">
        <div class="grid">
          <div class="stack">
            <label for="denomSelect">Select asset (IBC)</label>
            <select id="denomSelect"></select>
          </div>
          <div class="stack">
            <label for="amount">Amount</label>
            <input id="amount" type="number" placeholder="e.g., 1.5" step="0.000001" min="0" />
          </div>
        </div>

        <div class="row" style="margin-top:6px">
          <div class="pill">Available: <span id="balHuman" class="mono">0.000000</span><span id="quarkBadge" class="badge" style="display:none">QUARK</span></div>
          <div class="right row" style="gap:8px">
            <button id="btn50" type="button" class="ghost">50%</button>
            <button id="btn75" type="button" class="ghost">75%</button>
            <button id="btnMax" type="button" class="ghost">Max</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="sendBtn" type="button">Send to Osmosis</button>
          <input id="memo" class="right" style="max-width:320px" placeholder="Memo (optional)" />
        </div>
      </div>

      <div id="txWrap" style="display:none; margin-top:6px">
        <span>Tx: <a id="txLink" target="_blank" rel="noopener" class="pill mono">View on Mintscan</a></span>
      </div>

      <details class="diag"><summary>Diagnostics</summary><div id="diag" class="status"></div></details>
    </div>

    <div class="footer">Tip: serve over <b>https://</b>, allow Keplr on this site, and avoid aggressive ad-blockers on first load.</div>
  </div>

  <script>
    // ---------- Config ----------
    const CHANNEL = "channel-141";
    const DEFAULT_DECIMALS = 6;
    const GAS_PRICE = 0.035;  // uatom per gas
    const GAS_BUFFER = 1.6;
    const QUARK_IBC = "ibc/7B6EBFC446E50DFF981C994E207BFB398889706C2B0DF8A14D8B87F6C0E33A1A";

    const RPC_CANDIDATES = [
      "https://rpc.cosmos.directory/cosmoshub",
      "https://rpc-cosmoshub.blockapsis.com",
      "https://cosmoshub-validator.enigma-validator.com",
      "https://rpc.cosmoshub.strange.love",
      "https://rpc-cosmoshub-ia.cosmosia.notional.ventures",
    ];

    // ---------- State ----------
    let cosmosAddr = "", osmoAddr = "";
    let connectedRpc = "";
    let queryClient = null;        // StargateClient
    let signingClient = null;      // SigningStargateClient
    let signer = null;
    let balances = [];
    let connectInFlight = false, connected = false, inFlight = false;

    // ---------- UI ----------
    const connectBtn  = document.getElementById("connectBtn");
    const bootSpin    = document.getElementById("bootSpin");
    const statusEl    = document.getElementById("status");
    const addrWrap    = document.getElementById("addrWrap");
    const cosmosAddrEl= document.getElementById("cosmosAddr");
    const osmoAddrEl  = document.getElementById("osmoAddr");
    const rpcUsedEl   = document.getElementById("rpcUsed");
    const formWrap    = document.getElementById("formWrap");
    const denomSelect = document.getElementById("denomSelect");
    const amountInput = document.getElementById("amount");
    const balHumanEl  = document.getElementById("balHuman");
    const quarkBadge  = document.getElementById("quarkBadge");
    const memoInput   = document.getElementById("memo");
    const btn50 = document.getElementById("btn50");
    const btn75 = document.getElementById("btn75");
    const btnMax = document.getElementById("btnMax");
    const sendBtn = document.getElementById("sendBtn");
    const txWrap = document.getElementById("txWrap");
    const txLink = document.getElementById("txLink");
    const diagEl = document.getElementById("diag");
    const refreshBtn = document.getElementById("refreshBtn");
    const resetBtn = document.getElementById("resetBtn");

    // ---------- Utilities ----------
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    const addDiag = (m)=>{ const d=document.createElement("div"); d.textContent=m; diagEl.appendChild(d); };
    const setStatus = (m,cls="")=>{ statusEl.className="status "+cls; statusEl.textContent=m||""; };

    async function ensureCosmjsReady(){
      const start=Date.now();
      while(!window.cosmjs && Date.now()-start<3000) await sleep(100);
      if(window.cosmjs) return;
      try{
        const mod = await import("https://esm.sh/@cosmjs/stargate@0.31.2?bundle");
        window.cosmjs = {StargateClient:mod.StargateClient, SigningStargateClient:mod.SigningStargateClient};
      }catch(e){ addDiag("ESM import failed: "+(e?.message||e)); throw new Error("CosmJS failed to load."); }
    }
    async function waitForKeplr(timeoutMs=15000){
      const start=Date.now();
      while(!window.keplr && Date.now()-start<timeoutMs) await sleep(100);
      if(!window.keplr) throw new Error("Keplr not detected. Enable the extension.");
    }
    const withTimeout=(p,ms,label="op")=>Promise.race([
      p, new Promise((_,rej)=>setTimeout(()=>rej(new Error(label+" timed out")),ms))
    ]);

    // ---------- RPC / Clients ----------
    async function connectAnyRpc(){
      const {StargateClient}=window.cosmjs;
      for(const rpc of RPC_CANDIDATES){
        try{
          const c = await withTimeout(StargateClient.connect(rpc), 6000, "RPC connect");
          await withTimeout(c.getHeight(), 4000, "RPC height");
          connectedRpc = rpc; rpcUsedEl.textContent = rpc; return c;
        }catch(e){ addDiag(`RPC failed: ${rpc} — ${e?.message||e}`); }
      }
      throw new Error("All Cosmos Hub RPCs failed (CORS/offline).");
    }
    async function ensureQueryClient(){
      try{
        if(!queryClient){ queryClient = await connectAnyRpc(); }
        else { await withTimeout(queryClient.getHeight(), 4000, "RPC ping"); }
      }catch(_){ queryClient = await connectAnyRpc(); }
    }

    async function balancesWithRetries(addr){
      let last;
      for(let i=0;i<3;i++){
        try{
          await ensureQueryClient();
          const coins = await withTimeout(queryClient.getAllBalances(addr), 8000, "getAllBalances");
          return coins||[];
        }catch(e){ last=e; addDiag("balance fetch retry: "+(e?.message||e)); await sleep(600*(i+1)); queryClient=null; }
      }
      throw last||new Error("Failed to fetch balances.");
    }

    // ---------- Wallet helpers ----------
    async function enableChainsRobust(){
      try{
        await withTimeout(window.keplr.enable(["cosmoshub-4","osmosis-1"]), 15000, "Keplr enable");
      }catch(_){
        // Fallback: enable sequentially
        await withTimeout(window.keplr.enable("cosmoshub-4"), 15000, "Enable cosmoshub-4");
        await withTimeout(window.keplr.enable("osmosis-1"), 15000, "Enable osmosis-1");
      }
      // Hydrate internal state (prevents empty account edge)
      await withTimeout(window.keplr.getKey("cosmoshub-4"), 8000, "getKey cosmos");
      await withTimeout(window.keplr.getKey("osmosis-1"), 8000, "getKey osmo");
    }

    async function pollAccounts(getter, label){
      const start=Date.now();
      while(Date.now()-start<8000){
        const accs = await withTimeout(getter(), 4000, "getAccounts "+label);
        if(accs && accs.length>0) return accs;
        await sleep(200);
      }
      throw new Error(label+" accounts not available");
    }

    async function hydrateAddresses(){
      const cosSigner = window.getOfflineSignerAuto ? await window.getOfflineSignerAuto("cosmoshub-4")
                                                    : window.getOfflineSigner("cosmoshub-4");
      signer = cosSigner;
      const cosAcc = await pollAccounts(()=>signer.getAccounts(),"cosmos");
      cosmosAddr = cosAcc[0].address;

      const osmoSigner = window.getOfflineSigner ? window.getOfflineSigner("osmosis-1")
                                                 : await window.getOfflineSignerAuto("osmosis-1");
      const osmoAcc = await pollAccounts(()=>osmoSigner.getAccounts(),"osmosis");
      osmoAddr = osmoAcc[0].address;

      cosmosAddrEl.textContent = cosmosAddr;
      osmoAddrEl.textContent = osmoAddr;
    }

    async function warmUpSigning(){
      const {SigningStargateClient}=window.cosmjs;
      signingClient = await withTimeout(SigningStargateClient.connectWithSigner(connectedRpc, signer, {
        broadcastTimeoutMs: 60_000, broadcastPollIntervalMs: 3_000
      }), 12000, "signing connect");
      await withTimeout(signingClient.getSequence(cosmosAddr), 8000, "account sequence");
    }

    // ---------- Balances / UI ----------
    function toHuman(min, dec=DEFAULT_DECIMALS){ return (Number(min||0)/Math.pow(10,dec)).toFixed(6); }
    function toMinimal(h, dec=DEFAULT_DECIMALS){ return String(Math.round(Number(h)*Math.pow(10,dec))); }

    async function getIbcBalances(addr){
      const coins = await balancesWithRetries(addr);
      return coins.filter(c=>c.denom?.startsWith("ibc/") && BigInt(c.amount||"0")>0n);
    }

    function populateDropdown(){
      denomSelect.innerHTML = "";
      balances.sort((a,b)=>a.denom.localeCompare(b.denom));
      for(const c of balances){
        const isQuark = c.denom===QUARK_IBC;
        const opt = document.createElement("option");
        opt.value = c.denom;
        opt.textContent = `${isQuark ? "QUARK • " : ""}${c.denom} — ${toHuman(c.amount)}`;
        denomSelect.appendChild(opt);
      }
      if(balances.length){
        denomSelect.value = balances.find(x=>x.denom===QUARK_IBC)?.denom || balances[0].denom;
        updateSelected();
      }
      refreshBtn.style.display = balances.length ? "inline-block" : "none";
      resetBtn.style.display = "inline-block";
    }

    const findSelectedCoin = ()=> balances.find(c=>c.denom===denomSelect.value) || {amount:"0",denom:denomSelect.value};
    function updateSelected(){ const c=findSelectedCoin(); balHumanEl.textContent=toHuman(c.amount); quarkBadge.style.display=c.denom===QUARK_IBC?"inline-block":"none"; }
    function disableForm(dis){ denomSelect.disabled=dis; amountInput.disabled=dis; btn50.disabled=btn75.disabled=btnMax.disabled=dis; sendBtn.disabled=dis; memoInput.disabled=dis; }

    function wantRetry(msg){
      const m=(msg||"").toLowerCase();
      return m.includes("timeout") || (m.includes("insufficient")&&m.includes("fee")) || m.includes("out of gas") || m.includes("account sequence");
    }

    async function sendIbcWithRetries(coin, minimal, memo){
      let attempt=0,lastErr;
      while(attempt<3){
        attempt++;
        try{
          await withTimeout(signingClient.getSequence(cosmosAddr), 8000, "sequence");
          const msg = {
            typeUrl:"/ibc.applications.transfer.v1.MsgTransfer",
            value:{ sourcePort:"transfer", sourceChannel:CHANNEL, sender:cosmosAddr, receiver:osmoAddr,
                    token:{denom:coin.denom, amount:minimal}, timeoutHeight:{},
                    timeoutTimestamp:String((Date.now()+20*60*1000)*1e6) }
          };
          setStatus(attempt===1?"Simulating gas…":`Simulating gas… (retry ${attempt})`);
          const gasEst = await withTimeout(signingClient.simulate(cosmosAddr,[msg],memo||""), 12000, "simulate");
          const gas = Math.ceil(gasEst*GAS_BUFFER);
          const fee = {gas:String(gas), amount:[{denom:"uatom", amount:String(Math.ceil(gas*GAS_PRICE))}]};
          setStatus(attempt===1?"Broadcasting…":`Broadcasting… (retry ${attempt})`);
          const res = await withTimeout(signingClient.signAndBroadcast(cosmosAddr,[msg],fee,memo||""), 20000, "broadcast");
          if(res.code===0) return res;
          const raw = res.rawLog || `code ${res.code}`; if(!wantRetry(raw)) throw new Error(raw); lastErr=new Error(raw);
        }catch(e){ const em=e?.message||String(e); if(!wantRetry(em)) throw e; lastErr=e; await sleep(1200*attempt); }
      }
      throw lastErr||new Error("Broadcast failed.");
    }

    // ---------- Boot ----------
    document.addEventListener("DOMContentLoaded", async ()=>{
      try{
        setStatus("Preparing wallet…");
        await Promise.all([ensureCosmjsReady(), waitForKeplr()]);
        connectBtn.innerHTML="Connect Keplr"; connectBtn.disabled=false; bootSpin.style.display="none";
        setStatus("Ready to connect.");
        window.addEventListener("keplr_keystorechange", async ()=>{
          if(!connected) return;
          try{
            await enableChainsRobust();
            await hydrateAddresses();
            setStatus("Account changed. Updating balances…");
            balances = await getIbcBalances(cosmosAddr);
            populateDropdown();
            setStatus("Balances updated.", "ok");
          }catch(e){ addDiag("keystorechange refresh failed: "+(e?.message||e)); }
        });
      }catch(e){ setStatus("❌ "+(e?.message||e), "err"); }
    });

    // ---------- Events ----------
    denomSelect.onchange = updateSelected;
    btn50.onclick = ()=>{ const c=findSelectedCoin(); const half=(BigInt(c.amount)*50n)/100n; amountInput.value = toHuman(half.toString()); };
    btn75.onclick = ()=>{ const c=findSelectedCoin(); const three=(BigInt(c.amount)*75n)/100n; amountInput.value = toHuman(three.toString()); };
    btnMax.onclick = ()=>{ const c=findSelectedCoin(); amountInput.value = toHuman(c.amount); };

    refreshBtn.onclick = async ()=>{
      try{ setStatus("Refreshing balances…"); balances = await getIbcBalances(cosmosAddr); populateDropdown(); setStatus("Balances updated.","ok"); }
      catch(e){ setStatus("❌ "+(e?.message||e), "err"); }
    };

    resetBtn.onclick = async ()=>{
      // full teardown + allow a clean re-connect (mimics a soft refresh)
      try{
        setStatus("Resetting…");
        queryClient = null; signingClient = null; connected=false; connectInFlight=false;
        addrWrap.style.display="none"; formWrap.style.display="none"; txWrap.style.display="none";
        connectBtn.textContent="Connect Keplr"; connectBtn.disabled=false;
        setStatus("Ready to connect.");
      }catch{}
    };

    connectBtn.onclick = async ()=>{
      try{
        if(connectInFlight || connected) return;
        connectInFlight = true;
        connectBtn.disabled=true; connectBtn.innerHTML='<span class="spinner"></span>Connecting…';
        setStatus("Requesting Keplr permission…");

        await ensureCosmjsReady();
        await waitForKeplr();
        await enableChainsRobust();
        await hydrateAddresses();

        setStatus("Connecting RPC…");
        await ensureQueryClient();

        setStatus("Preparing signer…");
        await warmUpSigning();

        addrWrap.style.display="block";
        formWrap.style.display="block";

        setStatus("Fetching balances…");
        balances = await getIbcBalances(cosmosAddr);
        if(!balances.length) setStatus("No IBC balances found on Cosmos Hub.");
        else { populateDropdown(); setStatus("Connected.","ok"); }

        connected = true;
        connectBtn.textContent = "Connected ✅";
      }catch(e){
        console.error(e);
        setStatus("❌ "+(e?.message||e), "err");
        connectBtn.textContent = "Connect Keplr"; connectBtn.disabled=false;
      }finally{ connectInFlight=false; }
    };

    sendBtn.onclick = async ()=>{
      try{
        if(inFlight) return;
        const human = Number((amountInput.value||"").trim());
        if(!human || human<=0) return alert("Enter a valid amount.");

        const coin = findSelectedCoin();
        const minimal = toMinimal(human);
        if(BigInt(minimal) > BigInt(coin.amount||"0")) return alert("Amount exceeds available balance.");

        inFlight=true; disableForm(true); txWrap.style.display="none";
        sendBtn.innerHTML='<span class="spinner"></span>Sending…'; setStatus("Preparing transaction…");

        await enableChainsRobust(); // re-ensure permission if extension was locked
        const res = await sendIbcWithRetries(coin, minimal, memoInput.value||"");

        setStatus("✅ Sent!","ok"); sendBtn.textContent="Send to Osmosis";
        const hash = res.transactionHash||"";
        if(hash){ txWrap.style.display="block"; txLink.href=`https://www.mintscan.io/cosmos/txs/${hash}`; }

        setTimeout(async ()=>{
          try{
            const fresh = await balancesWithRetries(cosmosAddr);
            const updated = fresh.find(x=>x.denom===coin.denom) || {amount:"0", denom:coin.denom};
            coin.amount = updated.amount; updateSelected();
          }catch(_){}
        }, 2500);
      }catch(e){
        console.error(e);
        setStatus("❌ "+(e?.message||e), "err"); sendBtn.textContent="Send to Osmosis";
      }finally{
        inFlight=false; disableForm(false);
      }
    };
  </script>
</body>
</html>
