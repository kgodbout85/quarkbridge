<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QUARK Bridge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9fafb;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .card {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 420px;
      width: 100%;
    }
    h1 { text-align: center; margin-bottom: 1rem; }
    label { font-size: 0.9rem; color:#374151; }
    input, select, button {
      width: 100%;
      padding: 0.75rem;
      margin: 0.5rem 0;
      border-radius: 0.5rem;
      border: 1px solid #ddd;
      font-size: 1rem;
      background: #fff;
    }
    .row { display:flex; gap:.5rem; flex-wrap:wrap }
    .row button { flex:1 }
    button {
      background: #4f46e5;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:disabled { opacity: .5; cursor: not-allowed; }
    button:hover { background: #4338ca; }
    p.status { text-align: center; margin-top: 1rem; }
    p.warn { color:#b91c1c; text-align:center }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .muted { color:#6b7280; font-size:.9rem }
  </style>

  <!-- CosmJS UMD bundle (primary) -->
  <script src="https://unpkg.com/@cosmjs/stargate@0.31.2/build/index.min.js"></script>
  <!-- Fallback CDN if the first one is slow/blocked -->
  <script>
    (function ensureCosmjs(){
      setTimeout(function(){
        if (!window.cosmjs) {
          var s = document.createElement('script');
          s.src = "https://cdn.jsdelivr.net/npm/@cosmjs/stargate@0.31.2/build/index.min.js";
          document.head.appendChild(s);
        }
      }, 800);
    })();
  </script>
</head>
<body>
  <div class="card">
    <h1>QUARK Bridge</h1>
    <p style="text-align:center">
      Bridge any Cosmos balance to <b>Osmosis</b> (channel-141) using Keplr
    </p>

    <button id="connectBtn">Connect Keplr</button>

    <div id="addrBox" class="muted" style="display:none">
      Cosmos: <span class="mono" id="fromAddr"></span><br/>
      Osmosis: <span class="mono" id="toAddr"></span>
    </div>

    <div id="balanceUI" style="display:none">
      <label for="denomSelect">Select a token (denom)</label>
      <select id="denomSelect"></select>

      <div class="muted">
        Available: <span class="mono" id="balWhole">0.000000</span>
        (<span class="mono" id="balMinimal">0</span> minimal units)
      </div>

      <label for="amount">Amount</label>
      <input id="amount" type="number" placeholder="e.g., 1.5" step="0.000001" min="0" disabled />

      <div class="row">
        <button id="btn50" disabled>50%</button>
        <button id="btn75" disabled>75%</button>
        <button id="btnMax" disabled>Max</button>
      </div>
    </div>

    <button id="bridgeBtn" disabled>Bridge</button>

    <p id="status" class="status"></p>
    <p id="warning" class="warn"></p>
  </div>

  <script>
    // ---- Config ----
    const CHANNEL   = "channel-141"; // Cosmos → Osmosis
    const RPC       = "https://rpc.cosmoshub.strange.love";
    const DEFAULT_DECIMALS = 6; // most Cosmos assets use 6
    const QUARK_IBC = "ibc/7B6EBFC446E50DFF981C994E207BFB398889706C2B0DF8A14D8B87F6C0E33A1A";

    let fromAddress = "";
    let toAddress   = "";
    let cosmosSigner;

    let allBalances = [];        // full list from getAllBalances() + explicit QUARK
    let selectedDenom = "";      // user-selected denom
    let selectedBalMinimal = 0n; // balance of selected denom (minimal units)

    const connectBtn  = document.getElementById("connectBtn");
    const bridgeBtn   = document.getElementById("bridgeBtn");
    const amountInput = document.getElementById("amount");
    const statusEl    = document.getElementById("status");
    const warningEl   = document.getElementById("warning");
    const addrBox     = document.getElementById("addrBox");
    const fromAddrEl  = document.getElementById("fromAddr");
    const toAddrEl    = document.getElementById("toAddr");
    const denomSelect = document.getElementById("denomSelect");
    const balanceUI   = document.getElementById("balanceUI");
    const balWholeEl  = document.getElementById("balWhole");
    const balMinEl    = document.getElementById("balMinimal");

    const btn50 = document.getElementById("btn50");
    const btn75 = document.getElementById("btn75");
    const btnMax = document.getElementById("btnMax");

    if (!window.keplr) {
      warningEl.textContent = "⚠️ Keplr not detected. Open this page on HTTPS with Keplr installed/enabled.";
    }

    const toWhole = (minimal, dec = DEFAULT_DECIMALS) =>
      (Number(minimal || 0) / Math.pow(10, dec)).toFixed(6);
    const toMinimal = (whole, dec = DEFAULT_DECIMALS) =>
      String(Math.round(Number(whole) * Math.pow(10, dec)));

    async function ensureCosmjsReady() {
      const start = Date.now();
      while (!window.cosmjs && Date.now() - start < 2500) {
        await new Promise(r => setTimeout(r, 100));
      }
      if (!window.cosmjs) throw new Error("CosmJS failed to load. Refresh or disable content blockers.");
    }

    // Fetch all non-zero balances, then explicitly query QUARK so it shows up even at 0.
    async function fetchAllBalances() {
      await ensureCosmjsReady();
      const { StargateClient } = window.cosmjs;
      const q = await StargateClient.connect(RPC);

      const list = await q.getAllBalances(fromAddress) || [];

      // Ensure QUARK is present (even at 0)
      try {
        const quarkBal = await q.getBalance(fromAddress, QUARK_IBC); // { denom, amount }
        const existing = list.find(c => c.denom === QUARK_IBC);
        if (quarkBal) {
          if (!existing) list.push(quarkBal);
          else existing.amount = quarkBal.amount;
        }
      } catch (e) {
        console.debug("QUARK balance check error:", e?.message || e);
      }

      return list;
    }

    function populateDenoms(list) {
      denomSelect.innerHTML = "";

      // Sort: IBC/factory first, then alphabetical
      list.sort((a,b) => {
        const aKey = (a.denom.startsWith("ibc/") || a.denom.startsWith("factory/")) ? "0"+a.denom : "1"+a.denom;
        const bKey = (b.denom.startsWith("ibc/") || b.denom.startsWith("factory/")) ? "0"+b.denom : "1"+b.denom;
        return aKey.localeCompare(bKey);
      });

      for (const c of list) {
        const opt = document.createElement("option");
        opt.value = c.denom;
        opt.textContent = c.denom === QUARK_IBC ? `QUARK (${c.denom})` : c.denom;
        denomSelect.appendChild(opt);
      }

      if (list.find(c => c.denom === QUARK_IBC)) {
        denomSelect.value = QUARK_IBC;
      } else if (list.length > 0) {
        denomSelect.value = list[0].denom;
      }

      updateSelectedBalance();
    }

    function updateSelectedBalance() {
      selectedDenom = denomSelect.value;
      const coin = allBalances.find(c => c.denom === selectedDenom) || { amount: "0" };
      selectedBalMinimal = BigInt(coin.amount || "0");
      balMinEl.textContent = selectedBalMinimal.toString();
      balWholeEl.textContent = toWhole(selectedBalMinimal);
      amountInput.disabled = false;
      btn50.disabled = btn75.disabled = btnMax.disabled = false;
      bridgeBtn.disabled = false;
    }

    btn50.onclick = () => {
      const half = (selectedBalMinimal * 50n) / 100n;
      amountInput.value = toWhole(half);
    };
    btn75.onclick = () => {
      const threeQ = (selectedBalMinimal * 75n) / 100n;
      amountInput.value = toWhole(threeQ);
    };
    btnMax.onclick = () => { amountInput.value = toWhole(selectedBalMinimal); };

    denomSelect.onchange = updateSelectedBalance;

    connectBtn.onclick = async () => {
      try {
        if (!window.keplr) { alert("Keplr not found. Make sure it's installed and allowed on this site."); return; }

        // Enable both chains
        await window.keplr.enable(["cosmoshub-4", "osmosis-1"]);

        cosmosSigner = window.getOfflineSigner("cosmoshub-4");
        const cosmosAccounts = await cosmosSigner.getAccounts();
        fromAddress = cosmosAccounts[0]?.address || "";

        const osmoSigner = window.getOfflineSigner("osmosis-1");
        const osmoAccounts = await osmoSigner.getAccounts();
        toAddress = osmoAccounts[0]?.address || "";

        connectBtn.disabled = true;
        statusEl.textContent = "✅ Keplr connected!";
        warningEl.textContent = "";

        // Show addresses
        fromAddrEl.textContent = fromAddress || "—";
        toAddrEl.textContent = toAddress || "—";
        addrBox.style.display = "block";

        // Fetch balances and populate UI
        statusEl.textContent = "Fetching balances…";
        allBalances = await fetchAllBalances();
        if (!allBalances.length) {
          statusEl.textContent = "No balances found on Cosmos for this address.";
        } else {
          statusEl.textContent = "Balances loaded.";
        }
        balanceUI.style.display = "block";
        populateDenoms(allBalances);
      } catch (err) {
        console.error(err);
        statusEl.textContent = "❌ Error connecting: " + (err?.message || err);
      }
    };

    bridgeBtn.onclick = async () => {
      try {
        const amt = Number((amountInput.value || "").trim());
        if (!amt || amt <= 0) { alert("Enter a valid amount."); return; }
        const minimal = toMinimal(amt);

        if (BigInt(minimal) > selectedBalMinimal) {
          alert("Amount exceeds available balance.");
          return;
        }

        await ensureCosmjsReady();
        const { SigningStargateClient } = window.cosmjs || {};
        if (!SigningStargateClient) throw new Error("CosmJS (SigningStargateClient) unavailable");

        const client = await SigningStargateClient.connectWithSigner(RPC, cosmosSigner);

        const msg = {
          typeUrl: "/ibc.applications.transfer.v1.MsgTransfer",
          value: {
            sourcePort: "transfer",
            sourceChannel: CHANNEL,
            sender: fromAddress,
            receiver: toAddress,
            token: { denom: selectedDenom, amount: minimal },
            timeoutHeight: {},
            timeoutTimestamp: String((Date.now() + 10 * 60 * 1000) * 1e6),
          },
        };

        // static fee (uatom)
        const fee = { amount: [{ denom: "uatom", amount: "5000" }], gas: "200000" };

        statusEl.textContent = "Broadcasting…";
        const res = await client.signAndBroadcast(fromAddress, [msg], fee);

        if (res.code === 0) {
          statusEl.textContent = "✅ Success! Bridged to Osmosis.";
          // Refresh the balances after a short delay
          setTimeout(async () => {
            allBalances = await fetchAllBalances();
            populateDenoms(allBalances);
            statusEl.textContent = "Updated balances.";
          }, 2500);
        } else {
          statusEl.textContent = "❌ Failed: " + (res.rawLog || ("code " + res.code));
        }
      } catch (err) {
        console.error(err);
        statusEl.textContent = "❌ Error: " + (err?.message || err);
      }
    };
  </script>
</body>
</html>
