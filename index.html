<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QUARK Bridge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0a0f1b; --card:#121a2b; --text:#e6ebff; --muted:#9aa4c7; --accent:#6fd0ff; --danger:#ff6b6b; --border:#1c2742;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:var(--bg); color:var(--text); margin:0; display:flex; justify-content:center; align-items:center; padding:16px
    }
    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:18px; width:100%; max-width:520px; box-shadow:0 8px 24px rgba(0,0,0,.25)}
    h1{margin:0 0 10px; text-align:center}
    .small{font-size:12px; color:var(--muted)}
    input, button{width:100%; padding:10px; margin-top:8px; border-radius:12px; border:1px solid var(--border); background:#0f1627; color:var(--text); font-size:14px}
    input::placeholder{color:#8aa0c7}
    button{cursor:pointer; border:none; background:linear-gradient(90deg,#31a3ff,#7be3ff); color:#001018; font-weight:700}
    button:disabled{opacity:.45; cursor:not-allowed}
    .row{display:flex; gap:8px; flex-wrap:wrap}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .danger{color:var(--danger)}
    a{color:var(--accent); text-decoration:none}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted); background:#0e1a2d}
    .hint{background:#0e1a2d; border:1px dashed var(--border); padding:10px; border-radius:12px; margin-top:8px}
    .diag{margin-top:10px; font-size:12px; background:#0d1527; border:1px solid var(--border); border-radius:12px; padding:10px; white-space:pre-wrap}
  </style>
  <!-- CosmJS (browser bundle) -->
  <script src="https://unpkg.com/@cosmjs/stargate@0.31.2/build/index.min.js"></script>
</head>
<body>
  <div class="card">
    <h1>QUARK Bridge <span class="pill">Cosmos → Osmosis</span></h1>

    <div id="iframeWarn" class="hint" style="display:none">
      <b>Heads up:</b> This page is running inside an iframe/preview.  
      <a id="openTop" href="#" rel="noreferrer">Open in a new tab</a> so Keplr can connect.
    </div>

    <div id="permHint" class="hint" style="display:none">
      <b>Keplr is installed but blocked on this site.</b><br/>
      In Chrome: Extensions → Keplr → “<i>Site access</i>” → set <b>On all sites</b> (or allow on your <b>github.io</b> origin), then refresh.
    </div>

    <div class="row" style="margin-top:6px">
      <button id="connectBtn" disabled>Connect Keplr</button>
      <button id="refreshBtn" disabled>Refresh Balance</button>
      <button id="diagBtn">Diagnostics</button>
    </div>

    <div id="addrBox" class="small" style="margin-top:6px"></div>

    <div id="balanceBox" class="small" style="margin-top:8px">
      Balance: <span class="mono" id="balMin">0</span> minimal ≈ <span class="mono" id="balWhole">0</span> QUARK
    </div>

    <div style="margin-top:12px">
      <label class="small">Destination Osmosis address</label>
      <input id="toAddress" placeholder="osmo1..." />
      <div class="row">
        <button id="fillOsmoBtn" disabled>Use my Osmosis address</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <label class="small">Amount (QUARK)</label>
      <input id="amount" type="number" placeholder="e.g., 1.5" step="0.000001" min="0" disabled />
      <div class="row">
        <button id="halfBtn" disabled>50%</button>
        <button id="threeQBtn" disabled>75%</button>
        <button id="maxBtn" disabled>Max</button>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button id="bridgeBtn" disabled>Bridge</button>
    </div>

    <p id="status" class="small" style="text-align:center; margin-top:10px"></p>
    <p id="warning" class="small danger" style="text-align:center;"></p>
    <p id="explorer" class="small" style="text-align:center;"></p>

    <div id="diag" class="diag" style="display:none"></div>
  </div>

  <script>
    // ---------- CONFIG ----------
    // Working denom you used on GitHub Pages:
    const DENOM     = "factory/cosmos1n6asrjy9754q8y9jsxqf557zmsv3s3xa5m9eg5/quark";
    // If you need the IBC denom instead, swap to:
    // const DENOM  = "ibc/7B6EBFC446E50DFF981C994E207BFB398889706C2B0DF8A14D8B87F6C0E33A1A";
    const CHANNEL   = "channel-141";                 // Cosmos → Osmosis
    const DECIMALS  = 6;
    const RPC       = "https://rpc.cosmoshub.strange.love";
    const FEE_DENOM = "uatom";
    const GAS_PRICE = "0.025uatom";

    const { SigningStargateClient, StargateClient, GasPrice, calculateFee } = window.cosmjs;
    const $ = (id) => document.getElementById(id);

    const connectBtn  = $("connectBtn");
    const refreshBtn  = $("refreshBtn");
    const fillOsmoBtn = $("fillOsmoBtn");
    const bridgeBtn   = $("bridgeBtn");
    const amountInput = $("amount");
    const toInput     = $("toAddress");
    const statusEl    = $("status");
    const warningEl   = $("warning");
    const balMinEl    = $("balMin");
    const balWholeEl  = $("balWhole");
    const addrBox     = $("addrBox");
    const explorerEl  = $("explorer");
    const iframeWarn  = $("iframeWarn");
    const openTop     = $("openTop");
    const permHint    = $("permHint");
    const diagBtn     = $("diagBtn");
    const diagEl      = $("diag");
    const halfBtn     = $("halfBtn");
    const threeQBtn   = $("threeQBtn");
    const maxBtn      = $("maxBtn");

    let cosmosSigner, fromAddress = "", toAddress = "";
    let queryClient, signingClient;
    let balanceMinimal = 0n;

    // ---------- HELPERS ----------
    const toMinimal = (whole) => {
      const n = Number(whole);
      if (isNaN(n) || n <= 0) return 0n;
      return BigInt(Math.floor(n * 10 ** DECIMALS));
    };
    const toWhole = (minimal) => (!minimal ? "0" : String(Number(minimal) / 10 ** DECIMALS));
    const setStatus = (s) => statusEl.textContent = s || "";
    const setWarn   = (s) => warningEl.textContent = s || "";
    const uiEnable  = (on) => [refreshBtn, fillOsmoBtn, bridgeBtn, amountInput, halfBtn, threeQBtn, maxBtn].forEach(el => el.disabled = !on);

    const loadBalance = async () => {
      if (!queryClient || !fromAddress) return;
      const b = await queryClient.getBalance(fromAddress, DENOM);
      balanceMinimal = BigInt(b?.amount ?? "0");
      balMinEl.textContent = balanceMinimal.toString();
      balWholeEl.textContent = toWhole(balanceMinimal);
    };

    // ---------- IFRAME CHECK ----------
    if (window.top !== window) {
      iframeWarn.style.display = "block";
      openTop.onclick = (e) => {
        e.preventDefault();
        window.top.location.href = window.location.href;
      };
    }

    // ---------- WAIT FOR KEPLR INJECTION ----------
    async function waitForKeplr(maxMs = 15000) {
      const start = Date.now();
      while (!window.keplr) {
        await new Promise(r => setTimeout(r, 200));
        if (Date.now() - start > maxMs) break;
      }
      return !!window.keplr;
    }

    function dumpDiagnostics(extra = "") {
      const lines = [];
      lines.push(`location.href: ${location.href}`);
      lines.push(`top === window: ${window.top === window}`);
      lines.push(`keplr present: ${!!window.keplr}`);
      lines.push(`getOfflineSignerAuto on keplr: ${!!window.keplr?.getOfflineSignerAuto}`);
      lines.push(`legacy window.getOfflineSigner: ${!!window.getOfflineSigner}`);
      lines.push(`cosmjs present: ${!!window.cosmjs}`);
      if (extra) lines.push(`note: ${extra}`);
      diagEl.textContent = lines.join("\n");
      diagEl.style.display = "block";
    }

    diagBtn.onclick = () => dumpDiagnostics();

    async function connectKeplr() {
      try {
        setStatus("Connecting Keplr…"); setWarn(""); explorerEl.textContent = "";
        dumpDiagnostics("connect attempt");

        // Some environments need chains enabled one by one (not an array).
        await window.keplr.enable("cosmoshub-4");
        await window.keplr.enable("osmosis-1");

        // Prefer modern API on keplr, but fall back if extension injects legacy helper
        const signerCandidate =
          (window.keplr.getOfflineSignerAuto && await window.keplr.getOfflineSignerAuto("cosmoshub-4"))
          || (window.getOfflineSigner && window.getOfflineSigner("cosmoshub-4"));

        if (!signerCandidate) {
          setStatus("❌ Could not obtain signer. Check Keplr permissions for this site.");
          permHint.style.display = "block";
          return;
        }
        cosmosSigner = signerCandidate;

        const cosmosAccounts = await cosmosSigner.getAccounts();
        fromAddress = cosmosAccounts[0]?.address || "";

        // Optional Osmosis autofill
        let osmoSigner = null;
        if (window.keplr.getOfflineSignerAuto) {
          osmoSigner = await window.keplr.getOfflineSignerAuto("osmosis-1");
        } else if (window.getOfflineSigner) {
          osmoSigner = window.getOfflineSigner("osmosis-1");
        }
        if (osmoSigner) {
          const osmoAccounts = await osmoSigner.getAccounts();
          toAddress = osmoAccounts[0]?.address || "";
          if (toAddress) toInput.value = toAddress;
        }

        const gp = GasPrice.fromString(GAS_PRICE);
        signingClient = await SigningStargateClient.connectWithSigner(RPC, cosmosSigner, { gasPrice: gp });
        queryClient   = await StargateClient.connect(RPC);

        addrBox.innerHTML = `
          <div>Cosmos: <span class="mono">${fromAddress}</span></div>
          <div>Osmosis: <span class="mono">${toAddress || "—"}</span></div>
        `;
        await loadBalance();

        connectBtn.disabled = true;
        amountInput.disabled = false;
        uiEnable(true);
        setStatus("✅ Keplr connected.");
      } catch (err) {
        console.error(err);
        if (String(err).toLowerCase().includes("not allowed") || String(err).toLowerCase().includes("permission")) {
          permHint.style.display = "block";
        }
        setStatus("❌ Error connecting: " + (err?.message || err));
      }
    }

    (async () => {
      const hasKeplr = await waitForKeplr(15000);
      if (!hasKeplr) {
        setWarn("⚠️ Keplr not detected. Install it and allow access on this site (HTTPS).");
        connectBtn.disabled = true;
      } else {
        connectBtn.disabled = false;
      }
    })();

    // ---------- EVENTS ----------
    connectBtn.onclick = () => connectKeplr();

    window.addEventListener("keplr_keystorechange", async () => {
      try {
        if (!window.keplr) return;
        setStatus("Keystore changed. Re-connecting…");
        await connectKeplr();
      } catch {}
    });

    $("refreshBtn").onclick = async () => {
      try { setStatus("Refreshing balance…"); await loadBalance(); setStatus("Ready."); }
      catch (e){ console.error(e); setStatus("❌ Refresh failed: " + (e?.message || e)); }
    };

    $("fillOsmoBtn").onclick = async () => {
      try {
        await window.keplr.enable("osmosis-1");
        const osmoSigner =
          (window.keplr.getOfflineSignerAuto && await window.keplr.getOfflineSignerAuto("osmosis-1"))
          || (window.getOfflineSigner && window.getOfflineSigner("osmosis-1"));
        const accs = osmoSigner ? await osmoSigner.getAccounts() : [];
        toAddress = accs[0]?.address || "";
        if (toAddress) $("toAddress").value = toAddress;
        setStatus("Osmosis address set.");
      } catch (e) {
        console.error(e);
        setStatus("❌ Could not get Osmosis address: " + (e?.message || e));
      }
    };

    $("halfBtn").onclick = () => { $("amount").value = toWhole((balanceMinimal * 50n) / 100n); };
    $("threeQBtn").onclick = () => { $("amount").value = toWhole((balanceMinimal * 75n) / 100n); };
    $("maxBtn").onclick = () => { $("amount").value = toWhole(balanceMinimal); };

    $("bridgeBtn").onclick = async () => {
      try {
        setWarn(""); explorerEl.textContent = "";
        const recv = ($("toAddress").value || "").trim();
        if (!recv.startsWith("osmo1")) { setWarn("Destination must start with osmo1"); return; }
        const whole = Number(($("amount").value || "").trim());
        if (!whole || whole <= 0) { setWarn("Enter a valid QUARK amount."); return; }
        const amountMin = toMinimal(whole);
        if (amountMin <= 0n) { setWarn("Amount too small."); return; }
        if (amountMin > balanceMinimal) { setWarn("Amount exceeds balance."); return; }

        const msg = {
          typeUrl: "/ibc.applications.transfer.v1.MsgTransfer",
          value: {
            sourcePort: "transfer",
            sourceChannel: CHANNEL,
            sender: fromAddress,
            receiver: recv,
            token: { denom: DENOM, amount: amountMin.toString() },
            timeoutHeight: {},
            timeoutTimestamp: String((Date.now() + 10 * 60 * 1000) * 1e6),
          },
        };

        let fee;
        try {
          setStatus("Simulating…");
          const gasEst = await signingClient.simulate(fromAddress, [msg], "QUARK bridge");
          const gasWanted = Math.ceil(gasEst * 1.3);
          fee = calculateFee(gasWanted, GasPrice.fromString(GAS_PRICE));
        } catch {
          fee = { amount: [{ denom: FEE_DENOM, amount: "12000" }], gas: "300000" };
        }

        setStatus("Broadcasting…");
        const res = await signingClient.signAndBroadcast(fromAddress, [msg], fee, "QUARK bridge");
        if (res.code !== 0) { setStatus("❌ Failed: " + (res.rawLog || ("code " + res.code))); return; }
        setStatus("✅ Success!");
        $("explorer").innerHTML = `Mintscan: <a target="_blank" rel="noreferrer" href="https://www.mintscan.io/cosmos/txs/${res.transactionHash}">${res.transactionHash}</a>`;
        await loadBalance();
      } catch (err) {
        console.error(err);
        setStatus("❌ Error: " + (err?.message || err));
      }
    };
  </script>
</body>
</html>
