<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ICS20 Balances — Cosmos Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0f1222; color:#e9edff; display:flex; min-height:100vh; align-items:center; justify-content:center; padding:24px }
    .card { width:100%; max-width:720px; background:#151a33; border:1px solid #222a55; border-radius:16px; padding:20px; box-shadow:0 16px 40px rgba(0,0,0,.35) }
    h1 { margin:0 0 6px; font-size:20px }
    .sub { color:#aab3da; font-size:13px; margin:0 0 12px }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    button { background:#6d8bff; color:white; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-size:14px }
    button:disabled { opacity:.6; cursor:not-allowed }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace }
    .addr { background:#0f1533; border:1px solid #222a55; border-radius:12px; padding:10px 12px; font-size:13px; color:#bfc7ee }
    .status { color:#aab3da; min-height:20px; margin:8px 0 }
    .error { color:#ffb4c2 }
    table { width:100%; border-collapse:collapse; margin-top:10px; font-size:14px }
    th, td { padding:10px 8px; text-align:left; border-bottom:1px solid #222a55 }
    th { color:#cfd7ff; font-size:12px; letter-spacing:.2px }
    .tag { font-size:12px; color:#9fb2ff }
    .rpc { font-size:12px; color:#bfc7ee }
  </style>

  <!-- CosmJS UMD (primary + fallback). If blocked, ESM fallback below attaches window.cosmjs -->
  <script>
    (function loadCosmjsUMD() {
      function add(src){ const s=document.createElement("script"); s.src=src; s.async=true; document.head.appendChild(s); }
      add("https://unpkg.com/@cosmjs/stargate@0.31.2/build/index.min.js");
      setTimeout(()=>{ if(!window.cosmjs) add("https://cdn.jsdelivr.net/npm/@cosmjs/stargate@0.31.2/build/index.min.js"); }, 600);
    })();
  </script>
</head>
<body>
  <div class="card">
    <h1>ICS-20 Balances</h1>
    <p class="sub">Cosmos Hub (cosmoshub-4) • shows only <span class="mono">ibc/…</span> coins</p>

    <div class="row" style="margin-bottom:8px">
      <button id="connectBtn">Connect Keplr</button>
      <span id="status" class="status"></span>
    </div>

    <div id="addrWrap" class="addr" style="display:none">
      <div>Address: <span id="addr" class="mono"></span></div>
      <div class="rpc">RPC: <span id="rpcUsed" class="mono">—</span></div>
    </div>

    <div id="tableWrap" style="display:none">
      <table>
        <thead>
          <tr>
            <th>IBC Denom</th>
            <th>Amount (minimal)</th>
            <th>Amount (~human, 6dp)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div class="tag" style="margin-top:8px">Human amount assumes 6 decimals (most IBC assets use 6).</div>
    </div>

    <div id="diag" class="tag" style="margin-top:10px"></div>
  </div>

  <script>
    // ---------- Config ----------
    // Multiple RPCs; we try each until one connects (CORS-friendly first).
    const RPC_CANDIDATES = [
      "https://rpc.cosmos.directory/cosmoshub",            // cosmos.directory proxy (CORS open)
      "https://rpc-cosmoshub.blockapsis.com",              // Blockapsis (often CORS open)
      "https://cosmoshub-validator.enigma-validator.com",  // Enigma
      "https://rpc.cosmoshub.strange.love",                // may block CORS sometimes
      "https://rpc-cosmoshub-ia.cosmosia.notional.ventures"
    ];
    const DEFAULT_DECIMALS = 6;

    // ---------- State ----------
    let address = "";
    let connectedRpc = "";

    // ---------- UI ----------
    const connectBtn = document.getElementById("connectBtn");
    const statusEl   = document.getElementById("status");
    const addrWrap   = document.getElementById("addrWrap");
    const addrEl     = document.getElementById("addr");
    const rpcUsedEl  = document.getElementById("rpcUsed");
    const tableWrap  = document.getElementById("tableWrap");
    const tbody      = document.getElementById("tbody");
    const diagEl     = document.getElementById("diag");

    // ---------- CosmJS loader fallback (UMD → ESM) ----------
    async function ensureCosmjsReady() {
      const start = Date.now();
      while (!window.cosmjs && Date.now() - start < 2500) {
        await new Promise(r => setTimeout(r, 100));
      }
      if (window.cosmjs) return;
      try {
        const mod = await import("https://esm.sh/@cosmjs/stargate@0.31.2?bundle");
        window.cosmjs = { StargateClient: mod.StargateClient };
      } catch (e) {
        throw new Error("CosmJS failed to load (blocked by CSP/network).");
      }
    }

    // ---------- Connect to first working RPC ----------
    async function connectAnyRpc() {
      await ensureCosmjsReady();
      const { StargateClient } = window.cosmjs;
      let lastErr = null;
      for (const rpc of RPC_CANDIDATES) {
        try {
          const client = await StargateClient.connect(rpc);
          // quick sanity query to ensure node responds
          await client.getHeight();
          connectedRpc = rpc;
          return client;
        } catch (e) {
          lastErr = e;
          addDiag(`RPC failed: ${rpc} — ${e?.message || e}`);
        }
      }
      throw new Error("All RPCs failed (CORS or offline).");
    }

    function addDiag(msg) {
      const p = document.createElement("div");
      p.textContent = msg;
      diagEl.appendChild(p);
    }

    function toHuman(minimalStr, dec = DEFAULT_DECIMALS) {
      const n = Number(minimalStr || 0);
      return (n / Math.pow(10, dec)).toFixed(6);
    }

    async function getIbcBalances(client, addr) {
      const coins = await client.getAllBalances(addr);
      return (coins || []).filter(c => c.denom?.startsWith("ibc/") && BigInt(c.amount || "0") > 0n);
    }

    function renderBalances(coins) {
      tbody.innerHTML = "";
      for (const c of coins) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${c.denom}</td>
          <td class="mono">${c.amount}</td>
          <td class="mono">${toHuman(c.amount)}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    connectBtn.onclick = async () => {
      try {
        diagEl.textContent = "";
        statusEl.textContent = "Connecting Keplr…";
        if (!window.keplr) throw new Error("Keplr not detected. Use HTTPS and enable the extension.");

        await window.keplr.enable(["cosmoshub-4"]);
        const signer = window.getOfflineSigner("cosmoshub-4");
        const accounts = await signer.getAccounts();
        address = accounts[0]?.address || "";
        if (!address) throw new Error("No Cosmos Hub account found.");

        statusEl.textContent = "Finding a browser-friendly RPC…";
        const client = await connectAnyRpc();

        addrEl.textContent = address;
        rpcUsedEl.textContent = connectedRpc;
        addrWrap.style.display = "block";

        statusEl.textContent = "Fetching ICS-20 balances…";
        const ibcCoins = await getIbcBalances(client, address);

        tableWrap.style.display = "block";
        if (ibcCoins.length === 0) {
          statusEl.innerHTML = "No ICS-20 balances found on this address.";
          tbody.innerHTML = "";
          return;
        }

        renderBalances(ibcCoins);
        statusEl.textContent = `Found ${ibcCoins.length} IBC asset${ibcCoins.length>1?"s":""}.`;
      } catch (e) {
        console.error(e);
        statusEl.innerHTML = `<span class="error">❌ ${e?.message || e}</span>`;
        addDiag("Tip: serve over https:// (not file://) and disable content blockers on this page.");
      }
    };
  </script>
</body>
</html>
